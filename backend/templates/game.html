<!-- templates/game.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Room: {{ room_id }}</title>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    /* same grid & cell styling as before… */
    #board { display: grid; grid-template-columns: repeat(3,100px); grid-gap:5px; }
    .cell { width:100px; height:100px; display:flex;
            align-items:center; justify-content:center;
            font-size:2em; border:1px solid #333; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Room: {{ room_id }}</h1>
    <p>Player: {{ username }} ({{ user.wins }}–{{ user.losses }})</p>
    <a href="{{ url_for('logout') }}">Logout</a>
  </header>

  <div id="board">
    {% for i in range(9) %}
      <div id="cell{{i}}" class="cell" onclick="makeMove({{i}})"></div>
    {% endfor %}
  </div>

  <button id="startBtn" style="display:none;" onclick="startGame()">
    Start Game
  </button>

  <script>
    const socket = io();
    const room     = "{{ room_id }}";
    const username = "{{ username }}";
    let player, gameActive=false, currentTurn;

    socket.emit('join', { room, username });

    socket.on('joined', ({ role, board }) => {
      player = role;
      board.forEach((sym,i) => {
        document.getElementById('cell'+i).innerText = sym;
      });
    });

    socket.on('start_game', () => {
      document.getElementById('startBtn').style.display = 'inline-block';
    });

    function startGame() {
      socket.emit('start_game', { room });
    }

    socket.on('game_started', ({ startingPlayer }) => {
      document.getElementById('startBtn').style.display = 'none';
      gameActive=true; currentTurn=startingPlayer;
      for(let i=0;i<9;i++) document.getElementById('cell'+i).innerText='';
      if(currentTurn===player) alert("Your turn!");
    });

    function makeMove(i) {
      if(!gameActive||currentTurn!==player) return;
      socket.emit('make_move',{ room, index:i, player });
    }

    socket.on('update_board', ({ index, player: sym, nextTurn }) => {
      document.getElementById('cell'+index).innerText = sym;
      if(nextTurn) {
        currentTurn = nextTurn;
        if(currentTurn===player) alert("Your turn!");
      }
    });

    socket.on('game_over', ({ winner }) => {
      gameActive=false;
      if(winner) {
        alert(winner===username?"You win!":"You lose!");
      } else {
        alert("It's a draw!");
      }
      document.getElementById('startBtn').style.display='inline-block';
      setTimeout(()=>location.reload(),1000);
    });

    socket.on('invalid_move', ({ message }) => console.warn(message));
  </script>
</body>
</html>
