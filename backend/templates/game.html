<!-- templates/game.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Room: {{ room_id }}</title>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    /* same grid & cell styling as before… */
    /* #board { display: grid; grid-template-columns: repeat(3,100px); grid-gap:5px; }
    .cell { width:100px; height:100px; display:flex;
            align-items:center; justify-content:center;
            font-size:2em; border:1px solid #333; cursor:pointer; } */
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='tic-tac-toe.png') }}">

</head>
<body>
  <header>
    <h1>Room: {{ room_id }}</h1>
    <p>Player: {{ username }} ({{ user.wins }}–{{ user.losses }})</p>
    <p id="gameStatus">Waiting for players...</p>

    <a href="{{ url_for('logout') }}">Logout</a>
  </header>

    <!-- <div id="popupMessage" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%);
    background:#333; color:white; padding:20px 30px; border-radius:10px; font-size:1.5em; z-index:1000;">
    </div> -->
  <div id="board">
    {% for i in range(9) %}
      <div id="cell{{i}}" class="cell" onclick="makeMove({{i}})"></div>
    {% endfor %}
  </div>

  <button id="start-btn"
        class=" start-btn mt-6 hidden  text-white py-2 px-4 rounded-lg shadow-md transition duration-300"
        onclick="startGame()">
    Start Game
  </button>


  <script>
    const socket = io();
    const room     = "{{ room_id }}";
    const username = "{{ username }}";
    let player, gameActive=false, currentTurn;

    const gameStatus = document.getElementById('gameStatus');
    gameStatus.style.display = 'block';
    gameStatus.innerText = "Waiting for players...";

    socket.emit('join', { room, username });

    socket.on('joined', ({ role, board }) => {
      player = role;
      board.forEach((sym, i) => {
          const cell = document.getElementById('cell' + i);
          cell.innerHTML = '';
          if (sym === 'X' || sym === 'O') {
              const img = document.createElement('img');
              img.src = sym === 'X'
                  ? "{{ url_for('static', filename='x.png') }}"
                  : "{{ url_for('static', filename='o.png') }}";
              // img.style.width = '20%';
              // img.style.height = '20%';
              // img.style.objectFit = 'contain';
              cell.appendChild(img);
          }
      });
      gameStatus.innerText = "Joined as " + player + ". Waiting for another player...";
  });


    socket.on('start_game', () => {
        document.getElementById('start-btn').style.display = 'inline-block';
        gameStatus.innerText = "Both players joined. Click Start Game.";
    });

    function startGame() {
        socket.emit('start_game', { room });
    }

    socket.on('game_started', ({ startingPlayer }) => {
        document.getElementById('start-btn').style.display = 'none';
        gameActive=true; currentTurn=startingPlayer;
        for(let i=0;i<9;i++) document.getElementById('cell'+i).innerText='';
        gameStatus.innerText = currentTurn === player ? "Your turn!" : "Opponent's turn...";
    });

    function makeMove(i) {
        if(!gameActive||currentTurn!==player) return;
        socket.emit('make_move',{ room, index:i, player });
    }

    socket.on('update_board', ({ index, player: sym, nextTurn }) => {
      const cell = document.getElementById('cell' + index);
      const img = document.createElement('img');
      img.src = sym === 'X'
          ? "{{ url_for('static', filename='x.png') }}"
          : "{{ url_for('static', filename='o.png') }}";
      // img.style.width = '1px';
      // img.style.height = '1px';
      // img.style.objectFit = 'contain';

      // Clear the cell and add the image
      cell.innerHTML = '';
      cell.appendChild(img);

      if(nextTurn) {
        currentTurn = nextTurn;
        gameStatus.innerText = currentTurn === player ? "Your turn!" : "Opponent's turn...";
      }
    });

    socket.on('game_over', ({ winner }) => {
        gameActive = false;

        let title, icon;
        if (winner) {
            if (winner === username) {
                title = "You win!";
                icon = "success";
            } else {
                title = "You lose!";
                icon = "error";
            }
        } else {
            title = "It's a draw!";
            icon = "info";
        }

        Swal.fire({
            title: title,
            icon: icon,
            confirmButtonText: "OK",
            allowOutsideClick: false,
        }).then(() => {
            location.reload();  // reload after confirmation
        });

    document.getElementById('start-btn').style.display = 'inline-block';
});



    socket.on('invalid_move', ({ message }) => console.warn(message));
    </script>

</body>
</html>
