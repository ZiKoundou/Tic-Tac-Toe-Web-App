<!DOCTYPE html>
<html>
<head>
  <title>Tic Tac Toe</title>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Room: {{ room_id }}</h1>
    <h2>You are: {{ user.username }}</h2>

    <div>
        <p>Welcome, {{ user.username }}! You have {{ user.wins }} wins and {{ user.losses }} losses.</p>
    </div>

    <div id="board" style="display: grid; grid-template-columns: repeat(3, 100px); gap: 5px;">
        {% for i in range(9) %}
        <div onclick="makeMove({{ i }})" style="width:100px;height:100px;border:1px solid #000;display:flex;align-items:center;justify-content:center;font-size:30px;" id="cell{{ i }}"></div>
        {% endfor %}
    </div>

    <button onclick="resetBoard()">Reset</button>
    <a href="{{ url_for('logout') }}">Logout</a>

    <script>
        // Initialize socket connection
        const socket = io();

        // Get the room and username from the template variables
        const room = "{{ room_id }}";
        const username = "{{ user.username }}";
        let player = null; 

        window.onbeforeunload = function() {
            socket.emit('leave', { room: room, username: username });
        };

        socket.on('disconnect', function() {
            socket.emit('leave', { room: room, username: username });
        });

        // Emit join event to the server
        socket.emit('join', { room, username });

        socket.on('joined', ({ username, role, board }) => {
            console.log(`${username} joined as ${role}`);
            player = role;
            for (let i = 0; i < board.length; i++) {
                document.getElementById('cell' + i).innerText = board[i];
            }
        });

        // Handle click on a cell
        function makeMove(index) {
            if (player) {
                socket.emit('make_move', { room, index, player });
            }
        }


        // Listen for updates to the board
        socket.on('update_board', ({ index, player }) => {
            document.getElementById('cell' + index).innerText = player;
        });

        // Handle board reset
        function resetBoard() {
            socket.emit('reset', { room });
        }

        socket.on('reset_board', () => {
            for (let i = 0; i < 9; i++) {
                document.getElementById('cell' + i).innerText = '';
            }
        });
    </script>
</body>
</html>
